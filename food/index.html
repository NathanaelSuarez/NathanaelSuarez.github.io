<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Meal Planner</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="main-header">
        <h1>Dynamic Meal Planner</h1>
        <nav class="tab-navigation">
            <button id="tab-btn-inventory" class="tab-link active">1. Inventory</button>
            <button id="tab-btn-planner" class="tab-link">2. Create & View Plan</button>
        </nav>
    </header>

    <main>
        <!-- ============================================================================== -->
        <!-- TAB 1: INVENTORY (Largely unchanged)                                         -->
        <!-- ============================================================================== -->
        <div id="inventory" class="tab-content">
            <div class="container">
                <h2>Manage Your Food Inventory</h2>
                <p>Add, edit, and manage all possible food items here. This list acts as your master database for the planner.</p>
                <div class="flex-container card-container">
                    <div class="card" style="flex:1">
                        <h3>Load Existing JSON</h3>
                        <textarea id="loadArea" rows="8" placeholder="Paste your food JSON array here and click 'Load'"></textarea><br>
                        <button id="loadJsonBtn">Load JSON</button>
                    </div>
                    <div class="card" style="flex:1">
                        <h3>Export Inventory</h3>
                        <button id="exportJsonBtn">Generate JSON</button>
                        <button id="downloadJsonBtn">Download .json</button>
                        <textarea id="exportArea" rows="8" readonly placeholder="Your generated JSON will appear here"></textarea>
                    </div>
                </div>
                <div class="card">
                    <h2 id="formTitle">Add New Food</h2>
                    <form id="foodForm">
                        <div class="form-grid" id="inventory-form-grid">
                            <!-- This content is now fully generated by ui.js -->
                        </div><br>
                        <button type="submit" id="submitBtn">Add Food</button>
                        <button type="button" id="clearFormBtn">Clear</button>
                    </form>
                </div>
                <h2>Current Foods</h2>
                <table id="foodTable">
                    <thead><tr><th>Name</th><th>On-Hand</th><th>Cost</th><th>Cal</th><th>Prot</th><th>Carb</th><th>Fiber</th><th>Expire</th><th>Max/Day</th><th>Shoppable</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ============================================================================== -->
        <!-- TAB 2: UNIFIED PLANNER AND DISTRIBUTOR (REWORKED)                            -->
        <!-- ============================================================================== -->
        <div id="planner" class="tab-content" style="display:none;">
            <div class="container planner-layout">

                <!-- Column 1: Configuration -->
                <div class="config-column card">
                    <h3>Configuration</h3>
                    
                    <div class="plan-controls">
                        <button id="updatePlanBtn" class="primary-action">Generate / Update Plan</button>
                        <div class="sub-controls">
                            <label class="shopping-checkbox-label">
                                <input id="allowShopping" type="checkbox" checked>
                                Allow Shopping?
                            </label>
                            <div class="strength-control">
                                <label for="numGenerations">Opt. Strength</label>
                                <input id="numGenerations" type="number" value="5000" min="10" max="1000000" title="Higher numbers take longer but may yield a better plan.">
                            </div>
                        </div>
                    </div>
                    <div class="summary" id="warnings"></div>
                    
                    <hr style="border-top: 1px solid var(--border-color); border-bottom: none; margin: 20px 0;">

                    <h4>Plan Dates</h4>
                    <div class="row">
                        <label>Start Date</label>
                        <input id="startDate" type="date">
                    </div>
                    <div class="row">
                        <label>End Date</label>
                        <input id="endDate" type="date">
                    </div>

                    <h4>Daily Average Macro Ranges</h4>
                    <!-- This container will now be populated by JavaScript -->
                    <div class="macro-grid" id="macro-grid-container"></div>
                </div>

                <!-- Column 2: Results -->
                <div class="results-column">
                    <div class="card">
                        <h3>Plan Results</h3>
                        <div id="planSummary">No plan generated yet.</div>
                        <div id="planAveragesContainer" class="plan-averages"></div>
                        <div class="results-details-grid">
                            <div class="summary-section">
                                <h4>Shopping List</h4>
                                <div id="shoppingListContainer"></div>
                            </div>
                            <div class="summary-section">
                                <h4>Waste Analysis</h4>
                                <div id="wasteList"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                         <div id="plan-grid">
                            <!-- The daily meal plan grid will be rendered here by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- NEW: Finish Plan Button -->
                    <div id="finishPlanContainer" class="card" style="display: none; margin-top: 15px;">
                        <p style="text-align: center; margin: 0 0 15px 0;">This will subtract all <strong>completed</strong> items from your inventory and clear the current plan schedule.</p>
                        <button id="finishPlanBtn" class="danger" style="width: 100%;">Finish Plan & Update Inventory</button>
                    </div>
                    
                </div>

            </div>
        </div>
    </main>

    <!-- ============================================================================== -->
    <!-- MODAL FOR ADDING CUSTOM MEAL                                                 -->
    <!-- ============================================================================== -->
    <div id="customMealModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3 id="customMealModalTitle">Add Custom Meal Item</h3>
            <p>Manually add an item to a specific meal slot. This item will be "locked" and the optimizer will plan around it.</p>
            <form id="customMealForm">
                <input type="hidden" id="customMealDay">
                <input type="hidden" id="customMealSlot">
                <input type="hidden" id="customMealItemIndex">
                <div class="form-grid" id="custom-meal-form-grid">
                     <!-- This content is now fully generated by ui.js -->
                </div><br>
                <button type="submit" id="customMealSubmitBtn">Add Custom Item</button>
            </form>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>
</body>
</html>